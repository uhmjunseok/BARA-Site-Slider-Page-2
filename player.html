<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BARA Player – MICROCOSM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    :root{--vh:1vh}
    html,body{margin:0;height:100%;background:transparent;overflow:hidden;overscroll-behavior:none}
    .app{height:calc(var(--vh)*100)}
    .swiper{height:100%;touch-action:pan-y}
    .swiper-slide{height:50%!important;display:flex;align-items:center;justify-content:center}
    .frame{position:relative;height:100%;aspect-ratio:16/9;cursor:pointer}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .play{position:absolute;inset:0;margin:auto;width:0;height:0;border-top:18px solid transparent;border-bottom:18px solid transparent;border-left:30px solid #fff;pointer-events:none;opacity:.9}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .is-playing .thumb,.is-playing .play{opacity:0}
  </style>
</head>
<body>

<div class="app">
  <div class="swiper">
    <div class="swiper-wrapper">

      <!-- MICROCOSM I : RHYTHM -->
      <div class="swiper-slide">
        <div class="frame" data-video="DRPC2Ba7i7E">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739880/MICROCOSM_I_RHYTHM_%EB%B3%B5%EC%82%AC_sfdoka.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM II : INTRUSION -->
      <div class="swiper-slide">
        <div class="frame" data-video="Rp0HBSVz4hg">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739848/MICROCOSM_I_RHYTHM_Web_vr_%EB%B3%B5%EC%82%AC_zai26j.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM III : SPREAD -->
      <div class="swiper-slide">
        <div class="frame" data-video="EBvlq_t6CHA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739868/MICROCOSM_III_SPREAD_Web_vr_%EB%B3%B5%EC%82%AC_vqxm6c.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM IV : DISRUPTION -->
      <div class="swiper-slide">
        <div class="frame" data-video="TldWk1-rzIA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739919/Sequence_01_1_%EB%B3%B5%EC%82%AC2_n6jsnn.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
function setVh(){
  document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
}
setVh();
window.addEventListener('resize', setVh);
if (window.visualViewport) window.visualViewport.addEventListener('resize', setVh);

const swiper = new Swiper('.swiper', {
  direction:'vertical',
  slidesPerView:2,
  speed:280,

  // ✅ iframe/Readymag 환경에서 스크롤/스와이프 안정화
  nested:true,
  touchStartPreventDefault:false,
  resistanceRatio:0.85,

  mousewheel:{
    forceToAxis:true,
    sensitivity:0.6,
    thresholdDelta:30,
    thresholdTime:250
  }
});

const frames = Array.from(document.querySelectorAll('.frame'));

function stopOthers(current){
  frames.forEach(f=>{
    if(f !== current){
      f.classList.remove('is-playing');
      const i = f.querySelector('iframe');
      if(i) i.remove();
    }
  });
}

function notify(videoId){
  const msg = { type:'BARA_VIDEO_SELECT', videoId };
  try { window.top.postMessage(msg, '*'); } catch(e){}
}

frames.forEach(f=>{
  f.addEventListener('click', ()=>{
    if(f.classList.contains('is-playing')) return;

    const id = f.dataset.video;
    stopOthers(f);

    const i = document.createElement('iframe');
    i.src = `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&rel=0`;
    i.allow = 'autoplay; encrypted-media; picture-in-picture';
    i.allowFullscreen = true;

    f.appendChild(i);
    f.classList.add('is-playing');
    notify(id);
  }, { passive:true });
});

swiper.on('slideChange', ()=>{
  const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  if(f) notify(f.dataset.video);
});

// ✅ 첫 진입/뒤로가기 복귀에서 휠/터치가 안 먹는 케이스 방지
(function(){
  function focusFix(){
    try { window.focus(); } catch(e){}
    try { document.body && document.body.focus && document.body.focus(); } catch(e){}
  }
  window.addEventListener('load', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('pageshow', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('focus', function(){
    setTimeout(focusFix, 0);
  });
})();
</script>

</body>
</html>
