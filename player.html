<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BARA Player – MICROCOSM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    :root{--vh:1vh}
    html,body{margin:0;height:100%;background:transparent;overflow:hidden;overscroll-behavior:none}
    .app{height:calc(var(--vh)*100)}
    .swiper{height:100%;touch-action:pan-y}
    .swiper-slide{height:50%!important;display:flex;align-items:center;justify-content:center}
    .frame{position:relative;height:100%;aspect-ratio:16/9;cursor:pointer}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .play{position:absolute;inset:0;margin:auto;width:0;height:0;border-top:18px solid transparent;border-bottom:18px solid transparent;border-left:30px solid #fff;pointer-events:none;opacity:.9}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .is-playing .thumb,.is-playing .play{opacity:0}
  </style>
</head>
<body>

<div class="app">
  <div class="swiper">
    <div class="swiper-wrapper">

      <div class="swiper-slide">
        <div class="frame" data-video="DRPC2Ba7i7E">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739880/MICROCOSM_I_RHYTHM_%EB%B3%B5%EC%82%AC_sfdoka.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <div class="swiper-slide">
        <div class="frame" data-video="Rp0HBSVz4hg">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739848/MICROCOSM_I_RHYTHM_Web_vr_%EB%B3%B5%EC%82%AC_zai26j.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <div class="swiper-slide">
        <div class="frame" data-video="EBvlq_t6CHA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739868/MICROCOSM_III_SPREAD_Web_vr_%EB%B3%B5%EC%82%AC_vqxm6c.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <div class="swiper-slide">
        <div class="frame" data-video="TldWk1-rzIA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739919/Sequence_01_1_%EB%B3%B5%EC%82%AC2_n6jsnn.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
/* =========================
   1) VH 안정화
========================= */
function setVh(){
  document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
}
setVh();
window.addEventListener('resize', setVh);
if (window.visualViewport) window.visualViewport.addEventListener('resize', setVh);

/* =========================
   2) Swiper
========================= */
const swiper = new Swiper('.swiper', {
  direction:'vertical',
  slidesPerView:2,
  speed:280,
  nested:true,
  touchStartPreventDefault:false,
  resistanceRatio:0.85,
  mousewheel:{ forceToAxis:true, sensitivity:0.6, thresholdDelta:30, thresholdTime:250 }
});

const frames = Array.from(document.querySelectorAll('.frame'));

/* =========================
   3) 패널 연동: "변경 시 1회" + "요청 시 응답"
   - 재시도/복구는 TOP(페이지2 통괄)에서만 담당
========================= */
let currentVideoId = null;

function postTop(msg){
  try { window.top.postMessage(msg, '*'); } catch(e) {}
}

function notify(videoId){
  if (!videoId || typeof videoId !== 'string') return;
  if (videoId === currentVideoId) return; // ✅ 중복 방지
  currentVideoId = videoId;
  postTop({ type:'BARA_VIDEO_SELECT', videoId });
}

/* ✅ TOP이 상태를 요청하면 현재 선택을 1회 응답 */
window.addEventListener('message', function(ev){
  const data = ev.data;
  if (!data || !data.type) return;

  // ✅ 요청은 TOP에서만 받기 (다른 iframe/확장 스크립트 섞임 방지)
  if (ev.source !== window.top) return;

  if (data.type === 'BARA_REQUEST_STATE'){
    // currentVideoId가 없으면 activeIndex 기반으로 산출
    if (!currentVideoId){
      const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
      if (f && f.dataset.video) currentVideoId = f.dataset.video;
    }
    if (currentVideoId){
      postTop({ type:'BARA_VIDEO_SELECT', videoId: currentVideoId });
    }
    return;
  }
}, true);

/* ✅ player 준비 신호 (TOP이 복귀 타이밍 잡기 쉽게) */
function playerReady(){
  postTop({ type:'BARA_PLAYER_READY' });
}
playerReady();
setTimeout(playerReady, 60);
setTimeout(playerReady, 180);
window.addEventListener('load', playerReady);
window.addEventListener('pageshow', playerReady);

/* =========================
   4) 플레이
========================= */
function stopOthers(current){
  frames.forEach(f=>{
    if(f !== current){
      f.classList.remove('is-playing');
      const i = f.querySelector('iframe');
      if(i) i.remove();
    }
  });
}

frames.forEach(f=>{
  f.addEventListener('click', ()=>{
    if(f.classList.contains('is-playing')) return;

    const id = f.dataset.video;
    stopOthers(f);

    const i = document.createElement('iframe');
    i.src = `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&rel=0`;
    i.allow = 'autoplay; encrypted-media; picture-in-picture';
    i.allowFullscreen = true;

    f.appendChild(i);
    f.classList.add('is-playing');

    notify(id);
  }, { passive:true });
});

/* 슬라이드 변경 시도 중복 방지된 notify만 호출 */
swiper.on('slideChange', ()=>{
  const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  if(f && f.dataset.video) notify(f.dataset.video);
});

/* 최초 1회 상태 송신 */
setTimeout(function(){
  const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  if(f && f.dataset.video) notify(f.dataset.video);
}, 0);

/* =========================
   5) (옵션) 포커스 이슈 완화
========================= */
(function(){
  function focusFix(){
    try { window.focus(); } catch(e){}
    try { document.body && document.body.focus && document.body.focus(); } catch(e){}
  }
  window.addEventListener('load', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('pageshow', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('focus', function(){
    setTimeout(focusFix, 0);
  });
})();
</script>

</body>
</html>
