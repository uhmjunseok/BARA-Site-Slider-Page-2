<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BARA Player – MICROCOSM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    :root{--vh:1vh}
    html,body{margin:0;height:100%;background:transparent;overflow:hidden;overscroll-behavior:none}
    .app{height:calc(var(--vh)*100)}
    .swiper{height:100%;touch-action:pan-y}
    .swiper-slide{height:50%!important;display:flex;align-items:center;justify-content:center}
    .frame{position:relative;height:100%;aspect-ratio:16/9;cursor:pointer}
    .thumb{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .play{position:absolute;inset:0;margin:auto;width:0;height:0;border-top:18px solid transparent;border-bottom:18px solid transparent;border-left:30px solid #fff;pointer-events:none;opacity:.9}
    iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .is-playing .thumb,.is-playing .play{opacity:0}
  </style>
</head>
<body>

<div class="app">
  <div class="swiper">
    <div class="swiper-wrapper">

      <!-- MICROCOSM I : RHYTHM -->
      <div class="swiper-slide">
        <div class="frame" data-video="DRPC2Ba7i7E">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739880/MICROCOSM_I_RHYTHM_%EB%B3%B5%EC%82%AC_sfdoka.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM II : INTRUSION -->
      <div class="swiper-slide">
        <div class="frame" data-video="Rp0HBSVz4hg">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739848/MICROCOSM_I_RHYTHM_Web_vr_%EB%B3%B5%EC%82%AC_zai26j.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM III : SPREAD -->
      <div class="swiper-slide">
        <div class="frame" data-video="EBvlq_t6CHA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739868/MICROCOSM_III_SPREAD_Web_vr_%EB%B3%B5%EC%82%AC_vqxm6c.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

      <!-- MICROCOSM IV : DISRUPTION -->
      <div class="swiper-slide">
        <div class="frame" data-video="TldWk1-rzIA">
          <img class="thumb" src="https://res.cloudinary.com/dlzutetki/image/upload/v1765739919/Sequence_01_1_%EB%B3%B5%EC%82%AC2_n6jsnn.jpg" alt="">
          <div class="play"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
/* =========================
   1) VH 안정화
========================= */
function setVh(){
  document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
}
setVh();
window.addEventListener('resize', setVh);
if (window.visualViewport) window.visualViewport.addEventListener('resize', setVh);

/* =========================
   2) Swiper
========================= */
const swiper = new Swiper('.swiper', {
  direction:'vertical',
  slidesPerView:2,
  speed:280,
  nested:true,
  touchStartPreventDefault:false,
  resistanceRatio:0.85,
  mousewheel:{ forceToAxis:true, sensitivity:0.6, thresholdDelta:30, thresholdTime:250 }
});

const frames = Array.from(document.querySelectorAll('.frame'));

/* =========================
   3) 패널 연동: READY + boot + (추가) REQUEST_STATE 대응
========================= */
let lastMsg = null;           // {type:'BARA_VIDEO_SELECT', videoId}
let currentVideoId = null;    // ✅ 상태 요청 응답용
let panelReady = false;
let bootTimer = null;

function postTop(msg){
  try { window.top.postMessage(msg, '*'); } catch(e) {}
}

function notify(videoId){
  currentVideoId = videoId;               // ✅ 현재 상태 저장
  lastMsg = { type:'BARA_VIDEO_SELECT', videoId };
  postTop(lastMsg);
}

/* ✅ 패널 READY 수신 → 마지막 신호 즉시 재전송 */
window.addEventListener('message', function(ev){
  const data = ev.data;
  if (!data || !data.type) return;

  if (data.type === 'BARA_PANEL_READY'){
    panelReady = true;
    if (lastMsg) postTop(lastMsg);
    return;
  }

  // ✅ 중개가 상태를 요청하면, 마지막 선택을 다시 전송
  if (data.type === 'BARA_REQUEST_STATE'){
    if (!currentVideoId){
      const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
      if (f) currentVideoId = f.dataset.video;
    }
    if (currentVideoId){
      postTop({ type:'BARA_VIDEO_SELECT', videoId: currentVideoId });
    }
    return;
  }
}, true);

/* ✅ player 준비 신호 (중개가 복귀 타이밍 잡기 쉽게) */
function playerReady(){
  postTop({ type:'BARA_PLAYER_READY' });
}
playerReady();
setTimeout(playerReady, 60);
setTimeout(playerReady, 180);
window.addEventListener('load', playerReady);
window.addEventListener('pageshow', playerReady);

/* ✅ 첫 진입/복귀/탭 복귀에서 READY 지연 대비: 2초간 반복 송신 */
function boot(){
  panelReady = false;
  if (bootTimer) clearInterval(bootTimer);

  // lastMsg가 없으면 "현재 활성 슬라이드" 또는 첫 슬라이드로 초기화
  const activeFrame = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  const fallbackId =
    (activeFrame && activeFrame.dataset.video) ||
    (frames[0] && frames[0].dataset.video) ||
    null;

  if (!lastMsg && fallbackId){
    currentVideoId = fallbackId;
    lastMsg = { type:'BARA_VIDEO_SELECT', videoId:fallbackId };
  }

  let tries = 0;
  bootTimer = setInterval(function(){
    tries++;
    if (lastMsg) postTop(lastMsg);
    if (panelReady || tries > 40) clearInterval(bootTimer); // 2초
  }, 50);
}

/* 부팅 트리거들 */
window.addEventListener('load', boot);
window.addEventListener('pageshow', boot);
document.addEventListener('visibilitychange', function(){
  if (!document.hidden) boot();
});
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', function(){
    setTimeout(boot, 0);
  });
}
window.addEventListener('resize', function(){
  setTimeout(boot, 0);
});

/* =========================
   4) 플레이
========================= */
function stopOthers(current){
  frames.forEach(f=>{
    if(f !== current){
      f.classList.remove('is-playing');
      const i = f.querySelector('iframe');
      if(i) i.remove();
    }
  });
}

frames.forEach(f=>{
  f.addEventListener('click', ()=>{
    if(f.classList.contains('is-playing')) return;

    const id = f.dataset.video;
    stopOthers(f);

    const i = document.createElement('iframe');
    i.src = `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&rel=0`;
    i.allow = 'autoplay; encrypted-media; picture-in-picture';
    i.allowFullscreen = true;

    f.appendChild(i);
    f.classList.add('is-playing');

    notify(id);
  }, { passive:true });
});

swiper.on('slideChange', ()=>{
  const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  if(f) notify(f.dataset.video);
});

/* 첫 화면에서도 1회 신호 확보 + 부팅 */
setTimeout(function(){
  const f = swiper.slides[swiper.activeIndex]?.querySelector('.frame');
  if(f) notify(f.dataset.video);
  boot();
}, 0);

/* =========================
   5) (옵션) 포커스 이슈 완화
========================= */
(function(){
  function focusFix(){
    try { window.focus(); } catch(e){}
    try { document.body && document.body.focus && document.body.focus(); } catch(e){}
  }
  window.addEventListener('load', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('pageshow', function(){
    setTimeout(focusFix, 0);
    setTimeout(focusFix, 200);
  });
  window.addEventListener('focus', function(){
    setTimeout(focusFix, 0);
  });
})();
</script>

</body>
</html>
